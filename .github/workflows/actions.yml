---
name: CI/CD
run-name: ${{ github.event.pull_request.title || github.event.head_commit.message || github.ref_name }}

'on':
  push:
    branches: [main, staging]
  pull_request:
    branches: [main]
  schedule:
    - cron: '0 6 * * *'  # Daily at 6am UTC - full pipeline run to catch drift
  workflow_dispatch:
    inputs:
      run_firmware_upgrade:
        description: 'Run Pi firmware checks (slow, usually skip)'
        required: false
        default: 'false'
        type: boolean
      run_debian_upgrade:
        description: 'Run Debian upgrade checks'
        required: false
        default: 'false'
        type: boolean

permissions:
  contents: read
  actions: write

# Add concurrency control to prevent conflicting deployments
concurrency:
  # PRs: each run gets unique group (parallel execution)
  # main/staging: serialized to prevent Terraform state race conditions
  group: ${{ github.event_name == 'pull_request' && github.run_id || format('{0}-{1}', github.workflow, github.ref) }}
  cancel-in-progress: false

# Tailscale OAuth client ID for GitHub Actions (non-sensitive, like a username)
# Named to avoid conflict with Tailscale Terraform provider's auto-discovery
env:
  TS_OAUTH_CLIENT_ID: kwd6uysYz621CNTRL

jobs:
  # Detect which files changed to skip irrelevant jobs
  changes:
    name: "Detect Changes"
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      gcp: ${{ steps.filter.outputs.gcp }}
      oracle: ${{ steps.filter.outputs.oracle }}
      kubernetes: ${{ steps.filter.outputs.kubernetes }}
      ansible: ${{ steps.filter.outputs.ansible }}
      cloudflared: ${{ steps.filter.outputs.cloudflared }}
      tailscale: ${{ steps.filter.outputs.tailscale }}
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 1  # Shallow clone sufficient for path filtering
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            gcp:
              - 'gcp/**'
              - '.github/workflows/**'
            oracle:
              - 'oracle/**'
              - '.github/workflows/**'
            kubernetes:
              - 'kubernetes/**'
              - '.github/workflows/**'
            ansible:
              - 'ansible/tailscale.yml'
              - 'ansible/k3s.yml'
              - 'ansible/playbooks/**'
              - 'ansible/roles/**'
              - 'ansible/group_vars/**'
              - 'ansible/hosts.ini'
              - 'ansible/confs/**'
              - '.github/workflows/**'
            cloudflared:
              - 'ansible/playbooks/cloudflared.yml'
              - 'ansible/roles/cloudflared/**'
              - '.github/workflows/**'
            tailscale:
              - 'terraform/tailscale/**'
              - 'tailscale/**'
              - '.github/workflows/**'

  # Consolidated lint job - runs pre-commit checks once for all code
  # (markdownlint included via pre-commit, no separate docs-lint needed)
  lint:
    needs: changes
    name: "Lint & Format Checks"
    # Always run - pre-commit only checks changed files, so it's fast for small changes
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history needed for pre-commit diffs

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          terraform_version: "1.9.6"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'
          cache: 'pip'
          cache-dependency-path: |
            .pre-commit-config.yaml
            ansible/requirements.yml

      - name: Install linting tools
        run: |
          python3 -m pip install --upgrade pip
          pip3 install pre-commit 'ansible-core==2.20.0rc2' ansible-lint

      - name: Cache Ansible collections
        uses: actions/cache@v5
        with:
          path: ~/.ansible/collections
          key: ${{ runner.os }}-ansible-collections-${{ hashFiles('ansible/requirements.yml') }}
          restore-keys: |
            ${{ runner.os }}-ansible-collections-

      - name: Install Ansible collections
        run: ansible-galaxy collection install -r ansible/requirements.yml --force

      - name: Cache pre-commit environments
        uses: actions/cache@v5
        with:
          path: ~/.cache/pre-commit
          key: ${{ runner.os }}-pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Cache pre-commit hook repositories
        uses: actions/cache@v5
        with:
          path: ~/.cache/pre-commit/repo*
          key: ${{ runner.os }}-pre-commit-repos-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Run pre-commit on changed files
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
          fi

          # Handle workflow_dispatch or initial pushes where BASE_SHA is empty or all zeros
          if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
            echo "No base SHA available (workflow_dispatch or initial push), using HEAD~1"
            BASE_SHA="HEAD~1"
          fi

          CHANGED_FILES=$(git diff --name-only --diff-filter=ACM "$BASE_SHA" "${{ github.sha }}" 2>/dev/null || git ls-files)

          if [ -n "$CHANGED_FILES" ]; then
            echo "Running pre-commit on changed files:"
            echo "$CHANGED_FILES"
            echo "$CHANGED_FILES" | xargs pre-commit run --files
          else
            echo "No files changed, skipping pre-commit"
          fi

      - name: Lint Summary
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… All lint checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Lint checks failed" >> $GITHUB_STEP_SUMMARY
          fi

  Terraform-Infra:
    needs: [changes, lint]
    name: "Terraform ${{ matrix.display_name }}"
    if: github.ref != 'refs/heads/staging'
    runs-on: ubuntu-latest
    timeout-minutes: 30
    strategy:
      fail-fast: false
      matrix:
        workspace: [gcp, oracle]
        include:
          - workspace: gcp
            display_name: GCP
          - workspace: oracle
            display_name: Oracle
    defaults:
      run:
        working-directory: ./${{ matrix.workspace }}
    env:
      TF_PLUGIN_CACHE_DIR: /home/runner/.terraform.d/plugin-cache
    steps:
      - name: Check if workspace has changes
        id: check
        run: |
          # Run on schedule/dispatch regardless of changes (drift detection)
          if [[ "${{ github.event_name }}" == "schedule" || "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "has_changes=true" >> $GITHUB_OUTPUT
          elif [[ "${{ matrix.workspace }}" == "gcp" ]]; then
            echo "has_changes=${{ needs.changes.outputs.gcp == 'true' }}" >> $GITHUB_OUTPUT
          else
            echo "has_changes=${{ needs.changes.outputs.oracle == 'true' }}" >> $GITHUB_OUTPUT
          fi
        working-directory: .
        shell: bash

      - name: Skip if no changes
        if: steps.check.outputs.has_changes != 'true'
        run: echo "No changes for ${{ matrix.workspace }}, skipping" && exit 0
        working-directory: .

      - name: Checkout
        if: steps.check.outputs.has_changes == 'true'
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup SOPS
        if: steps.check.outputs.has_changes == 'true'
        uses: ./.github/actions/setup-sops
        with:
          age_secret_key: ${{ secrets.SOPS_AGE_SECRET_KEY }}

      - name: Decrypt GCP secrets
        if: steps.check.outputs.has_changes == 'true' && matrix.workspace == 'gcp'
        run: |
          cd ${{ github.workspace }}
          GOOGLE_CREDENTIALS="$(sops -d --extract '["gcp_credentials"]' secrets/terraform.yaml | jq -c '.')"
          TF_API_TOKEN="$(sops -d --extract '["api_token"]' secrets/terraform.yaml)"
          echo "::add-mask::$GOOGLE_CREDENTIALS"
          echo "::add-mask::$(echo "$GOOGLE_CREDENTIALS" | jq -r '.private_key_id // empty')"
          echo "::add-mask::$(echo "$GOOGLE_CREDENTIALS" | jq -r '.private_key // empty')"
          echo "::add-mask::$(echo "$GOOGLE_CREDENTIALS" | jq -r '.client_id // empty')"
          echo "::add-mask::$TF_API_TOKEN"
          echo "GOOGLE_CREDENTIALS=$GOOGLE_CREDENTIALS" >> $GITHUB_ENV
          echo "TF_API_TOKEN=$TF_API_TOKEN" >> $GITHUB_ENV

      - name: Decrypt Oracle secrets
        if: steps.check.outputs.has_changes == 'true' && matrix.workspace == 'oracle'
        run: |
          cd ${{ github.workspace }}
          OCI_PRIVATE_KEY_RAW="$(sops -d --extract '["oci_private_key"]' secrets/terraform.yaml)"
          OCI_PRIVATE_KEY="$(printf '%b' "$OCI_PRIVATE_KEY_RAW")"
          TF_API_TOKEN="$(sops -d --extract '["api_token"]' secrets/terraform.yaml)"
          while IFS= read -r line; do
            [ -n "$line" ] && echo "::add-mask::$line"
          done <<< "$OCI_PRIVATE_KEY"
          echo "::add-mask::$TF_API_TOKEN"
          TF_VAR_oci_private_key="$(printf '%s' "$OCI_PRIVATE_KEY" | base64 -w 0)"
          echo "::add-mask::$TF_VAR_oci_private_key"
          echo "TF_VAR_oci_private_key=$TF_VAR_oci_private_key" >> $GITHUB_ENV
          echo "TF_API_TOKEN=$TF_API_TOKEN" >> $GITHUB_ENV

      - name: Setup Terraform
        if: steps.check.outputs.has_changes == 'true'
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          cli_config_credentials_token: ${{ env.TF_API_TOKEN }}
          terraform_version: "1.9.6"

      - name: Setup and Run Pre-commit
        if: steps.check.outputs.has_changes == 'true'
        uses: ./.github/actions/setup-precommit

      - name: Cache Terraform
        if: steps.check.outputs.has_changes == 'true'
        uses: actions/cache@v5
        with:
          path: |
            /home/runner/.terraform.d/plugin-cache
            ${{ matrix.workspace }}/.terraform
          key: ${{ runner.os }}-terraform-${{ matrix.workspace }}-${{ hashFiles('**/*.tf', '**/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-${{ matrix.workspace }}-

      - name: Create plugin cache directory
        if: steps.check.outputs.has_changes == 'true'
        run: mkdir -p /home/runner/.terraform.d/plugin-cache

      - name: Terraform Format
        if: steps.check.outputs.has_changes == 'true'
        run: terraform fmt -check

      - name: Terraform Init
        if: steps.check.outputs.has_changes == 'true'
        run: terraform init

      - name: Terraform Validate
        if: steps.check.outputs.has_changes == 'true'
        run: terraform validate

      - name: Terraform Plan
        if: steps.check.outputs.has_changes == 'true'
        run: terraform plan -no-color -out=plan.tfplan

      - name: Save Terraform Plan
        if: steps.check.outputs.has_changes == 'true' && github.event_name == 'pull_request'
        uses: actions/upload-artifact@v6
        with:
          name: ${{ matrix.workspace }}-terraform-plan
          path: ./${{ matrix.workspace }}/plan.tfplan
          retention-days: 1
          compression-level: 9

      - name: Terraform Apply
        if: |
          steps.check.outputs.has_changes == 'true' &&
          github.ref == 'refs/heads/main' &&
          (github.event_name == 'push' || github.event_name == 'schedule')
        run: terraform apply -auto-approve -input=false

      - name: Terraform Summary
        if: always() && steps.check.outputs.has_changes == 'true'
        run: |
          echo "## Terraform ${{ matrix.workspace }}" >> $GITHUB_STEP_SUMMARY

      - name: Terraform Plan Summary
        if: steps.check.outputs.has_changes == 'true'
        uses: ./.github/actions/terraform-plan-summary
        with:
          plan_file: 'plan.tfplan'
          job_name: ${{ matrix.display_name }}

  Ansible-Tailscale:
    name: "Ansible Tailscale"
    needs: [changes, Terraform-Infra]
    if: |
      !cancelled() &&
      (needs.Terraform-Infra.result == 'success' || needs.Terraform-Infra.result == 'skipped') &&
      (needs.changes.outputs.ansible == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: ./ansible

    steps:
      - name: Check out the codebase
        uses: actions/checkout@v6
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup SOPS
        uses: ./.github/actions/setup-sops
        with:
          age_secret_key: ${{ secrets.SOPS_AGE_SECRET_KEY }}

      - name: Decrypt Tailscale secret
        run: |
          cd ${{ github.workspace }}
          TS_SECRET="$(sops -d --extract '["tailscale_oauth_client_secret"]' secrets/terraform.yaml)"
          echo "::add-mask::$TS_SECRET"
          echo "TAILSCALE_CLIENT_SECRET=$TS_SECRET" >> $GITHUB_ENV

      - name: Setup Ansible Environment
        uses: ./.github/actions/setup-ansible
        with:
          tailscale_client_id: ${{ env.TS_OAUTH_CLIENT_ID }}
          tailscale_client_secret: ${{ env.TAILSCALE_CLIENT_SECRET }}

      - name: Dry-run check (PR only)
        if: github.event_name == 'pull_request'
        id: dry_run
        continue-on-error: true
        run: |
          echo "## ðŸ” Ansible Dry-Run Preview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Detect which playbooks have changes
          PIS_CHANGED=false
          TAILSCALE_CHANGED=false
          K3S_CHANGED=false
          SECURITY_CHANGED=false
          HOSTS_INI_CHANGED=false

          # Check if hosts.ini changed (important for Tailscale SSH migration)
          if git diff --name-only origin/main...HEAD | grep -E '^ansible/hosts\.ini'; then
            HOSTS_INI_CHANGED=true
            echo "### âš ï¸ hosts.ini Changed - Testing Connectivity" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Testing Ansible connectivity to all nodes via Tailscale SSH..." >> $GITHUB_STEP_SUMMARY
            ansible all -i hosts.ini -m ping --one-line 2>&1 | tee connectivity_test.log || true
            cat connectivity_test.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if git diff --name-only origin/main...HEAD | grep -E '^ansible/(playbooks/pis\.yml|roles/(common|network)/|group_vars/pis\.yml)'; then
            PIS_CHANGED=true
          fi

          if git diff --name-only origin/main...HEAD | grep -E '^ansible/tailscale\.yml'; then
            TAILSCALE_CHANGED=true
          fi

          if git diff --name-only origin/main...HEAD | grep -E '^ansible/(playbooks/security\.yml|roles/(fail2ban|firewall)/|group_vars/public_nodes\.yml)'; then
            SECURITY_CHANGED=true
          fi

          if git diff --name-only origin/main...HEAD | grep -E '^ansible/(k3s\.yml|k3s-master-config\.yaml|roles/k3s[^/]+/|playbooks/k3s\.yml)'; then
            K3S_CHANGED=true
          fi

          # If hosts.ini changed, also run a basic dry-run on at least one playbook to verify end-to-end
          if [ "$HOSTS_INI_CHANGED" = true ]; then
            echo "### End-to-End Connectivity Test" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Running dry-run on a sample node to verify Tailscale SSH works end-to-end..." >> $GITHUB_STEP_SUMMARY
            # Try to run a dry-run on a simple playbook or just test with a single node
            if [ -f playbooks/pis.yml ]; then
              ansible-playbook -i hosts.ini playbooks/pis.yml --check --limit michael-pi 2>&1 | head -20 | tee e2e_test.log || true
            elif [ -f tailscale.yml ]; then
              ansible-playbook -i hosts.ini tailscale.yml --check --limit pam-amd1 2>&1 | head -20 | tee e2e_test.log || true
            else
              echo "No playbooks found for end-to-end test" >> e2e_test.log
            fi
            cat e2e_test.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Check pis playbook only if related files changed
          if [ "$PIS_CHANGED" = true ] && [ -f playbooks/pis.yml ]; then
            echo "### Pis Playbook Check" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Running syntax check only (--check without --diff to protect sensitive content)" >> $GITHUB_STEP_SUMMARY
            ansible-playbook -i hosts.ini playbooks/pis.yml \
              --check 2>&1 | tee dry_run.log || true
            cat dry_run.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ Pis playbook - no changes detected, skipping dry-run" >> $GITHUB_STEP_SUMMARY
          fi

          # Check tailscale playbook only if related files changed
          if [ "$TAILSCALE_CHANGED" = true ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Tailscale Playbook Check" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Running syntax check only (--check without --diff)" >> $GITHUB_STEP_SUMMARY
            ansible-playbook -i hosts.ini tailscale.yml \
              --check 2>&1 | tee tailscale_dry_run.log || true
            cat tailscale_dry_run.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â­ï¸ Tailscale playbook - no changes detected, skipping dry-run" >> $GITHUB_STEP_SUMMARY
          fi

          # Check k3s playbook only if related files changed
          if [ "$K3S_CHANGED" = true ] && [ -f k3s.yml ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### k3s Playbook Check" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Running syntax check only (--check without --diff to protect sensitive content)" >> $GITHUB_STEP_SUMMARY
            ansible-playbook -i hosts.ini k3s.yml --check 2>&1 | tee k3s_dry_run.log || true
            cat k3s_dry_run.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â­ï¸ k3s playbook - no changes detected, skipping dry-run" >> $GITHUB_STEP_SUMMARY
          fi

          # Check security playbook only if related files changed
          if [ "$SECURITY_CHANGED" = true ] && [ -f playbooks/security.yml ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Security Playbook Check" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Running syntax check for fail2ban and firewall deployment" >> $GITHUB_STEP_SUMMARY
            ansible-playbook -i hosts.ini playbooks/security.yml \
              --check 2>&1 | tee security_dry_run.log || true
            cat security_dry_run.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â­ï¸ Security playbook - no changes detected, skipping dry-run" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run tailscale-playbook
        id: tailscale_playbook
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          ansible-playbook -i hosts.ini tailscale.yml

      - name: tailscale-playbook Summary
        if: always()
        run: |
          if [ "${{ steps.tailscale_playbook.outcome }}" = "success" ]; then
            echo "âœ… tailscale-playbook succeeded." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.tailscale_playbook.outcome }}" = "skipped" ]; then
            echo "â­ï¸ tailscale-playbook skipped (PR dry-run only)." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ tailscale-playbook failed." >> $GITHUB_STEP_SUMMARY
          fi

  Ansible-Pis:
    name: "Ansible Pis"
    needs: [changes, Ansible-Tailscale]
    if: |
      !cancelled() &&
      (needs.Ansible-Tailscale.result == 'success' || needs.Ansible-Tailscale.result == 'skipped') &&
      (needs.changes.outputs.ansible == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule') &&
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    timeout-minutes: 60
    defaults:
      run:
        working-directory: ./ansible

    steps:
      - name: Check out the codebase
        uses: actions/checkout@v6
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup SOPS
        uses: ./.github/actions/setup-sops
        with:
          age_secret_key: ${{ secrets.SOPS_AGE_SECRET_KEY }}

      - name: Decrypt Tailscale secret
        run: |
          cd ${{ github.workspace }}
          TS_SECRET="$(sops -d --extract '["tailscale_oauth_client_secret"]' secrets/terraform.yaml)"
          echo "::add-mask::$TS_SECRET"
          echo "TAILSCALE_CLIENT_SECRET=$TS_SECRET" >> $GITHUB_ENV

      - name: Setup Ansible Environment
        uses: ./.github/actions/setup-ansible
        with:
          tailscale_client_id: ${{ env.TS_OAUTH_CLIENT_ID }}
          tailscale_client_secret: ${{ env.TAILSCALE_CLIENT_SECRET }}

      - name: Run pis-playbook
        id: pis_playbook
        if: |
          (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
          (github.event_name == 'workflow_dispatch')
        env:
          TAILSCALE_JOIN_KEY: ${{ secrets.TAILSCALE_JOIN_KEY }}
          # Skip slow upgrade checks by default, enable via workflow_dispatch inputs
          FIRMWARE_UPGRADE: ${{ github.event.inputs.run_firmware_upgrade || 'false' }}
          DEBIAN_UPGRADE: ${{ github.event.inputs.run_debian_upgrade || 'false' }}
        run: |
          ansible-playbook -i hosts.ini playbooks/pis.yml \
            -e "firmware_upgrade_enabled=$FIRMWARE_UPGRADE" \
            -e "debian_upgrade_enabled=$DEBIAN_UPGRADE"

      - name: pis-playbook Summary
        if: always()
        run: |
          if [ "${{ steps.pis_playbook.outcome }}" = "success" ]; then
            echo "âœ… pis-playbook succeeded." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.pis_playbook.outcome }}" = "skipped" ]; then
            echo "â­ï¸ pis-playbook skipped (PR dry-run only)." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ pis-playbook failed." >> $GITHUB_STEP_SUMMARY
          fi

  Ansible-Security:
    name: "Ansible Security"
    needs: [changes, Ansible-Tailscale]
    if: |
      !cancelled() &&
      (needs.Ansible-Tailscale.result == 'success' || needs.Ansible-Tailscale.result == 'skipped') &&
      (needs.changes.outputs.ansible == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule') &&
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: ./ansible

    steps:
      - name: Check out the codebase
        uses: actions/checkout@v6
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup SOPS
        uses: ./.github/actions/setup-sops
        with:
          age_secret_key: ${{ secrets.SOPS_AGE_SECRET_KEY }}

      - name: Decrypt Tailscale secret
        run: |
          cd ${{ github.workspace }}
          TS_SECRET="$(sops -d --extract '["tailscale_oauth_client_secret"]' secrets/terraform.yaml)"
          echo "::add-mask::$TS_SECRET"
          echo "TAILSCALE_CLIENT_SECRET=$TS_SECRET" >> $GITHUB_ENV

      - name: Setup Ansible Environment
        uses: ./.github/actions/setup-ansible
        with:
          tailscale_client_id: ${{ env.TS_OAUTH_CLIENT_ID }}
          tailscale_client_secret: ${{ env.TAILSCALE_CLIENT_SECRET }}

      - name: Run security-playbook
        id: security_playbook
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          ansible-playbook -i hosts.ini playbooks/security.yml

      - name: security-playbook Summary
        if: always()
        run: |
          if [ "${{ steps.security_playbook.outcome }}" = "success" ]; then
            echo "âœ… security-playbook succeeded." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.security_playbook.outcome }}" = "skipped" ]; then
            echo "â­ï¸ security-playbook skipped (PR dry-run only)." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ security-playbook failed." >> $GITHUB_STEP_SUMMARY
          fi

  Ansible-K3S:
    name: "Ansible K3S"
    needs: [changes, Ansible-Pis]
    if: |
      !cancelled() &&
      (needs.Ansible-Pis.result == 'success' || needs.Ansible-Pis.result == 'skipped') &&
      (needs.changes.outputs.ansible == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule') &&
      (github.ref == 'refs/heads/main' || github.event_name == 'workflow_dispatch')
    runs-on: ubuntu-latest
    timeout-minutes: 45
    defaults:
      run:
        working-directory: ./ansible

    steps:
      - name: Check out the codebase
        uses: actions/checkout@v6
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup SOPS
        uses: ./.github/actions/setup-sops
        with:
          age_secret_key: ${{ secrets.SOPS_AGE_SECRET_KEY }}

      - name: Decrypt Tailscale secret
        run: |
          cd ${{ github.workspace }}
          TS_SECRET="$(sops -d --extract '["tailscale_oauth_client_secret"]' secrets/terraform.yaml)"
          echo "::add-mask::$TS_SECRET"
          echo "TAILSCALE_CLIENT_SECRET=$TS_SECRET" >> $GITHUB_ENV

      - name: Setup Ansible Environment
        uses: ./.github/actions/setup-ansible
        with:
          tailscale_client_id: ${{ env.TS_OAUTH_CLIENT_ID }}
          tailscale_client_secret: ${{ env.TAILSCALE_CLIENT_SECRET }}

      - name: Run k3s-playbook
        id: k3s_playbook
        env:
          TAILSCALE_JOIN_KEY: ${{ secrets.TAILSCALE_JOIN_KEY }}
        run: |
          ansible-playbook -i hosts.ini k3s.yml

      - name: k3s-playbook Summary
        if: always()
        run: |
          if [ "${{ steps.k3s_playbook.outcome }}" = "success" ]; then
            echo "k3s-playbook succeeded." >> $GITHUB_STEP_SUMMARY
          else
            echo "k3s-playbook failed." >> $GITHUB_STEP_SUMMARY
          fi

  Terraform-K8S:
    name: "Terraform K8S"
    needs: [changes, lint, Ansible-K3S]
    if: |
      !cancelled() &&
      (needs.Ansible-K3S.result == 'success' || needs.Ansible-K3S.result == 'skipped') &&
      github.ref != 'refs/heads/staging' &&
      (needs.changes.outputs.kubernetes == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: ./kubernetes
    env:
      TF_PLUGIN_CACHE_DIR: /home/runner/.terraform.d/plugin-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0  # Full history needed for pre-commit diffs (until PR #285 merges)

      - name: Setup SOPS
        uses: ./.github/actions/setup-sops
        with:
          age_secret_key: ${{ secrets.SOPS_AGE_SECRET_KEY }}

      - name: Decrypt Tailscale secret for runner
        run: |
          cd ${{ github.workspace }}
          TS_SECRET="$(sops -d --extract '["tailscale_oauth_client_secret"]' secrets/terraform.yaml)"
          echo "::add-mask::$TS_SECRET"
          echo "TAILSCALE_CLIENT_SECRET=$TS_SECRET" >> $GITHUB_ENV

      - name: Setup Tailscale
        uses: tailscale/github-action@v4.1.1
        with:
          oauth-client-id: ${{ env.TS_OAUTH_CLIENT_ID }}
          oauth-secret: ${{ env.TAILSCALE_CLIENT_SECRET }}
          tags: tag:k3s

      - name: Decrypt secrets
        run: |
          cd ${{ github.workspace }}
          # Decrypt secrets - use printf %b to convert \n to actual newlines
          KUBE_CERT_RAW="$(sops -d --extract '["kube_client_cert"]' secrets/kube.yaml)"
          KUBE_KEY_RAW="$(sops -d --extract '["kube_client_key"]' secrets/kube.yaml)"
          KUBE_CA_RAW="$(sops -d --extract '["kube_cluster_ca_cert"]' secrets/kube.yaml)"
          TF_VAR_kube_client_cert="$(printf '%b' "$KUBE_CERT_RAW")"
          TF_VAR_kube_client_key="$(printf '%b' "$KUBE_KEY_RAW")"
          TF_VAR_kube_cluster_ca_cert="$(printf '%b' "$KUBE_CA_RAW")"
          TF_VAR_cloudflare_api_token="$(sops -d --extract '["cloudflare_api_token"]' secrets/terraform.yaml)"
          TF_VAR_tailscale_oauth_client_secret="$(sops -d --extract '["tailscale_oauth_client_secret"]' secrets/terraform.yaml)"
          TF_VAR_velero_s3_access_key="$(sops -d --extract '["velero_s3_access_key"]' secrets/terraform.yaml)"
          TF_VAR_velero_s3_secret_key="$(sops -d --extract '["velero_s3_secret_key"]' secrets/terraform.yaml)"
          TF_API_TOKEN="$(sops -d --extract '["api_token"]' secrets/terraform.yaml)"
          # Mask each line of multiline secrets
          for secret in "$TF_VAR_kube_client_cert" "$TF_VAR_kube_client_key" "$TF_VAR_kube_cluster_ca_cert"; do
            while IFS= read -r line; do
              [ -n "$line" ] && echo "::add-mask::$line"
            done <<< "$secret"
          done
          echo "::add-mask::$TF_VAR_cloudflare_api_token"
          echo "::add-mask::$TF_VAR_tailscale_oauth_client_secret"
          echo "::add-mask::$TF_VAR_velero_s3_access_key"
          echo "::add-mask::$TF_VAR_velero_s3_secret_key"
          echo "::add-mask::$TF_API_TOKEN"
          # Write to GITHUB_ENV
          echo "TF_VAR_kube_client_cert<<EOFCERT" >> $GITHUB_ENV
          echo "$TF_VAR_kube_client_cert" >> $GITHUB_ENV
          echo "EOFCERT" >> $GITHUB_ENV
          echo "TF_VAR_kube_client_key<<EOFKEY" >> $GITHUB_ENV
          echo "$TF_VAR_kube_client_key" >> $GITHUB_ENV
          echo "EOFKEY" >> $GITHUB_ENV
          echo "TF_VAR_kube_cluster_ca_cert<<EOFCA" >> $GITHUB_ENV
          echo "$TF_VAR_kube_cluster_ca_cert" >> $GITHUB_ENV
          echo "EOFCA" >> $GITHUB_ENV
          echo "TF_VAR_cloudflare_api_token=$TF_VAR_cloudflare_api_token" >> $GITHUB_ENV
          echo "TF_VAR_tailscale_oauth_client_secret=$TF_VAR_tailscale_oauth_client_secret" >> $GITHUB_ENV
          echo "TF_VAR_velero_s3_access_key=$TF_VAR_velero_s3_access_key" >> $GITHUB_ENV
          echo "TF_VAR_velero_s3_secret_key=$TF_VAR_velero_s3_secret_key" >> $GITHUB_ENV
          echo "TF_API_TOKEN=$TF_API_TOKEN" >> $GITHUB_ENV
          # Note: tailscale_oauth_client_id comes from kubernetes/terraform.tfvars

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          cli_config_credentials_token: ${{ env.TF_API_TOKEN }}
          terraform_version: "1.9.6"

      - name: Setup and Run Pre-commit
        uses: ./.github/actions/setup-precommit

      # Cache Terraform plugins and initialization files
      # Note: .terraform.lock.hcl is excluded from cache to avoid restore-keys
      # overwriting the tracked lock file with stale provider versions
      - name: Cache Terraform
        uses: actions/cache@v5
        with:
          path: |
            /home/runner/.terraform.d/plugin-cache
            kubernetes/.terraform
          key: ${{ runner.os }}-terraform-k8s-${{ hashFiles('**/*.tf', '**/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-k8s-

      - name: Create plugin cache directory
        run: mkdir -p /home/runner/.terraform.d/plugin-cache

      - name: Terraform Format
        id: fmt
        run: terraform fmt -check

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: "Terraform Plan"
        id: plan
        run: terraform plan -no-color -out=plan.tfplan

      - name: Terraform Apply
        id: apply
        if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'schedule' || github.event_name == 'workflow_dispatch')
        run: terraform apply -auto-approve -input=false

      - name: Terraform Apply Summary
        if: always()
        run: |
          if [ "${{ steps.apply.outcome }}" = "success" ]; then
            echo "Terraform apply succeeded." >> $GITHUB_STEP_SUMMARY
          else
            echo "Terraform apply failed." >> $GITHUB_STEP_SUMMARY
          fi

      # Add drift detection (guarded to post-apply on main) with safe exit-code capture
      - name: Check for Infrastructure Drift
        id: drift_check
        if: github.ref == 'refs/heads/main' && github.event_name == 'push' && steps.apply.outcome == 'success'
        run: |
          # plan exit codes: 0=no change, 1=error, 2=changes (drift)
          set +e
          terraform plan -detailed-exitcode -out=drift.tfplan
          code=$?
          set -e
          if [ "$code" -eq 1 ]; then
            echo "Terraform plan encountered an error (exit 1)."
            exit 1
          fi
          echo "drift_exitcode=$code" >> "$GITHUB_OUTPUT"

      - name: Drift Detection Summary
        if: always() && github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          exitcode="${{ steps.drift_check.outputs.drift_exitcode }}"
          if [ -z "$exitcode" ]; then
            echo "Drift detection did not run (non-main or apply skipped)." >> $GITHUB_STEP_SUMMARY
          elif [ "$exitcode" -eq 0 ]; then
            echo "Drift detection: no changes detected." >> $GITHUB_STEP_SUMMARY
          elif [ "$exitcode" -eq 2 ]; then
            echo "Drift detection: configuration drift detected." >> $GITHUB_STEP_SUMMARY
          else
            echo "Drift detection completed with unexpected exit code: $exitcode" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Terraform Plan Summary
        uses: ./.github/actions/terraform-plan-summary
        with:
          plan_file: 'plan.tfplan'
          job_name: 'Kubernetes'

  # cloudflared-deploy job removed - cloudflared now runs in Kubernetes
  # See: homelab-deployments/src/cloudflared for the K8s Deployment

  Terraform-Tailscale:
    name: "Terraform Tailscale"
    needs: [changes, lint]
    if: |
      !cancelled() &&
      (needs.changes.outputs.tailscale == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: ./terraform/tailscale
    steps:
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - name: Setup SOPS
        uses: ./.github/actions/setup-sops
        with:
          age_secret_key: ${{ secrets.SOPS_AGE_SECRET_KEY }}

      - name: Decrypt terraform secrets
        run: |
          cd ${{ github.workspace }}
          TF_API_TOKEN="$(sops -d --extract '["api_token"]' secrets/terraform.yaml)"
          TS_OAUTH_SECRET="$(sops -d --extract '["tailscale_oauth_client_secret"]' secrets/terraform.yaml)"
          echo "::add-mask::$TF_API_TOKEN"
          echo "::add-mask::$TS_OAUTH_SECRET"
          echo "TF_API_TOKEN=$TF_API_TOKEN" >> $GITHUB_ENV
          echo "TS_OAUTH_SECRET=$TS_OAUTH_SECRET" >> $GITHUB_ENV

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          cli_config_credentials_token: ${{ env.TF_API_TOKEN }}
          terraform_version: "1.9.6"

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: |
          terraform plan -out=plan-tailscale.tfplan \
            -var="tailscale_oauth_client_id=${{ env.TS_OAUTH_CLIENT_ID }}" \
            -var="tailscale_oauth_client_secret=${{ env.TS_OAUTH_SECRET }}"

      - name: Terraform Plan Summary
        uses: ./.github/actions/terraform-plan-summary
        with:
          plan_file: 'plan-tailscale.tfplan'
          job_name: 'Tailscale'

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' && (github.event_name == 'push' || github.event_name == 'schedule')
        run: |
          terraform apply -auto-approve plan-tailscale.tfplan

      - name: Tailscale Summary
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Tailscale apply succeeded." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Tailscale apply failed." >> $GITHUB_STEP_SUMMARY
          fi
