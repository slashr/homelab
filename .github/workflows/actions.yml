---
'on':
  push:
    branches: [main, staging]
  pull_request:
    branches: [main]
  workflow_dispatch:  # Allow manual triggering

permissions:
  contents: read
  actions: write

# Add concurrency control to prevent conflicting deployments
concurrency:
  # PRs: each run gets unique group (parallel execution)
  # main/staging: serialized to prevent Terraform state race conditions
  group: ${{ github.event_name == 'pull_request' && github.run_id || format('{0}-{1}', github.workflow, github.ref) }}
  cancel-in-progress: false

jobs:
  # Detect which files changed to skip irrelevant jobs
  changes:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: read
    outputs:
      gcp: ${{ steps.filter.outputs.gcp }}
      oracle: ${{ steps.filter.outputs.oracle }}
      kubernetes: ${{ steps.filter.outputs.kubernetes }}
      ansible: ${{ steps.filter.outputs.ansible }}
      tailscale: ${{ steps.filter.outputs.tailscale }}
      docs-only: ${{ steps.filter.outputs.docs-only }}
    steps:
      - uses: actions/checkout@v5
        with:
          fetch-depth: 1  # Shallow clone sufficient for path filtering
      - uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            gcp:
              - 'gcp/**'
              - '.github/workflows/**'
            oracle:
              - 'oracle/**'
              - '.github/workflows/**'
            kubernetes:
              - 'kubernetes/**'
              - '.github/workflows/**'
            ansible:
              - 'ansible/vpn.yml'
              - 'ansible/k3s.yml'
              - 'ansible/playbooks/**'
              - 'ansible/roles/**'
              - 'ansible/group_vars/**'
              - 'ansible/hosts.ini'
              - 'ansible/confs/**'
              - '.github/workflows/**'
            tailscale:
              - 'terraform/tailscale/**'
              - 'tailscale/**'
              - '.github/workflows/**'
            docs-only:
              - '**/*.md'
              - 'LICENSE'
              - 'AGENTS.md'

  docs-lint:
    needs: changes
    name: "Docs Lint"
    if: needs.changes.outputs.docs-only == 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 5
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'
          cache: 'pip'
          cache-dependency-path: .pre-commit-config.yaml

      - name: Install pre-commit
        run: |
          python3 -m pip install --upgrade pip
          pip3 install pre-commit

      - name: Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: ${{ runner.os }}-pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Run markdownlint on changed markdown files
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
          fi

          if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
            echo "No base SHA available (workflow_dispatch or initial push), using HEAD~1"
            BASE_SHA="HEAD~1"
          fi

          CHANGED_MD=$(git diff --name-only --diff-filter=ACM "$BASE_SHA" "${{ github.sha }}" -- '*.md' 2>/dev/null || true)

          if [ -n "$CHANGED_MD" ]; then
            echo "Running markdownlint on changed markdown files:"
            echo "$CHANGED_MD"
            echo "$CHANGED_MD" | xargs pre-commit run markdownlint --files
          else
            echo "No markdown files changed, skipping markdownlint"
          fi

      - name: Docs lint summary
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Docs lint passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Docs lint failed" >> $GITHUB_STEP_SUMMARY
          fi

  # Consolidated lint job - runs pre-commit checks once for all code
  lint:
    needs: changes
    name: "Lint & Format Checks"
    # Skip only for docs-only changes
    if: needs.changes.outputs.docs-only != 'true' || github.event_name == 'push'
    runs-on: ubuntu-latest
    timeout-minutes: 10
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history needed for pre-commit diffs

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          terraform_version: "1.9.6"

      - name: Set up Python
        uses: actions/setup-python@v6
        with:
          python-version: '3.x'
          cache: 'pip'
          cache-dependency-path: |
            .pre-commit-config.yaml
            ansible/requirements.yml

      - name: Install linting tools
        run: |
          python3 -m pip install --upgrade pip
          pip3 install pre-commit 'ansible-core==2.20.0rc2' ansible-lint

      - name: Cache Ansible collections
        uses: actions/cache@v4
        with:
          path: ~/.ansible/collections
          key: ${{ runner.os }}-ansible-collections-${{ hashFiles('ansible/requirements.yml') }}
          restore-keys: |
            ${{ runner.os }}-ansible-collections-

      - name: Install Ansible collections
        run: ansible-galaxy collection install -r ansible/requirements.yml --force

      - name: Cache pre-commit environments
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit
          key: ${{ runner.os }}-pre-commit-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Cache pre-commit hook repositories
        uses: actions/cache@v4
        with:
          path: ~/.cache/pre-commit/repo*
          key: ${{ runner.os }}-pre-commit-repos-${{ hashFiles('.pre-commit-config.yaml') }}

      - name: Run pre-commit on changed files
        run: |
          if [ "${{ github.event_name }}" = "pull_request" ]; then
            BASE_SHA="${{ github.event.pull_request.base.sha }}"
          else
            BASE_SHA="${{ github.event.before }}"
          fi

          # Handle workflow_dispatch or initial pushes where BASE_SHA is empty or all zeros
          if [ -z "$BASE_SHA" ] || [ "$BASE_SHA" = "0000000000000000000000000000000000000000" ]; then
            echo "No base SHA available (workflow_dispatch or initial push), using HEAD~1"
            BASE_SHA="HEAD~1"
          fi

          CHANGED_FILES=$(git diff --name-only --diff-filter=ACM "$BASE_SHA" "${{ github.sha }}" 2>/dev/null || git ls-files)

          if [ -n "$CHANGED_FILES" ]; then
            echo "Running pre-commit on changed files:"
            echo "$CHANGED_FILES"
            echo "$CHANGED_FILES" | xargs pre-commit run --files
          else
            echo "No files changed, skipping pre-commit"
          fi

      - name: Lint Summary
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… All lint checks passed" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Lint checks failed" >> $GITHUB_STEP_SUMMARY
          fi

  gcp-setup:
    needs: [changes, lint]
    name: "Terraform GCP"
    if: |
      github.ref != 'refs/heads/staging' &&
      (needs.changes.outputs.gcp == 'true' || github.event_name == 'push')
    runs-on: ubuntu-latest
    timeout-minutes: 30  # Add timeout to prevent hanging jobs
    defaults:
      run:
        working-directory: ./gcp
    env:
      GOOGLE_CREDENTIALS: ${{ secrets.GCP_CREDENTIALS }}
      TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history needed for pre-commit diffs (until PR #285 merges)

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_version: "1.9.6"  # Pin Terraform version

      - name: Setup and Run Pre-commit
        uses: ./.github/actions/setup-precommit

      # Cache Terraform plugins and initialization files
      # Note: .terraform.lock.hcl is excluded from cache to avoid restore-keys
      # overwriting the tracked lock file with stale provider versions
      - name: Cache Terraform
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
            gcp/.terraform
          key: ${{ runner.os }}-terraform-gcp-${{ hashFiles('**/*.tf', '**/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-gcp-

      - name: Create plugin cache directory
        run: mkdir -p ~/.terraform.d/plugin-cache

      - name: Terraform Format
        id: fmt
        run: terraform fmt -check

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        id: validate
        run: terraform validate

      - name: Terraform Plan
        id: plan
        run: terraform plan -no-color -out=terraform.tfplan

      # Save plan as artifact for review
      - name: Save Terraform Plan
        uses: actions/upload-artifact@v5
        if: github.event_name == 'pull_request'
        with:
          name: gcp-terraform-plan
          path: ./gcp/terraform.tfplan
          retention-days: 1
          compression-level: 9  # Maximum compression for faster uploads

      - name: Terraform Apply
        id: apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: terraform apply -auto-approve -input=false

      - name: Terraform Apply Summary
        if: always()
        run: |
          if [ "${{ steps.apply.outcome }}" = "success" ]; then
            echo "Terraform apply succeeded." >> $GITHUB_STEP_SUMMARY
          else
            echo "Terraform apply failed." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Terraform Plan Summary
        uses: ./.github/actions/terraform-plan-summary
        with:
          plan_file: 'terraform.tfplan'
          job_name: 'GCP'

  oracle-setup:
    needs: [changes, lint]
    name: "Terraform Oracle"
    if: |
      github.ref != 'refs/heads/staging' &&
      (needs.changes.outputs.oracle == 'true' || github.event_name == 'push')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: ./oracle
    env:
      TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
      TF_VAR_user_ocid: ${{ secrets.TF_USER_OCID }}
      TF_VAR_tenancy_ocid: ${{ secrets.TF_TENANCY_OCID }}
      TF_VAR_ssh_authorized_keys: ${{ secrets.TF_SSH_AUTHORIZED_KEYS }}
      TF_VAR_oci_private_key: ${{ secrets.TF_OCI_PRIVATE_KEY }}
      TF_VAR_fingerprint: ${{ secrets.TF_FINGERPRINT }}
      TF_VAR_compartment_id: ${{ secrets.TF_COMPARTMENT_ID }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history needed for pre-commit diffs (until PR #285 merges)

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_version: "1.9.6"  # Pin Terraform version

      - name: Setup and Run Pre-commit
        uses: ./.github/actions/setup-precommit

      # Cache Terraform plugins and initialization files
      # Note: .terraform.lock.hcl is excluded from cache to avoid restore-keys
      # overwriting the tracked lock file with stale provider versions
      - name: Cache Terraform
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
            oracle/.terraform
          key: ${{ runner.os }}-terraform-oracle-${{ hashFiles('**/*.tf', '**/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-oracle-

      - name: Create plugin cache directory
        run: mkdir -p ~/.terraform.d/plugin-cache

      - name: Terraform Format
        id: fmt
        run: terraform fmt -check

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: "Terraform Plan"
        id: plan
        run: terraform plan -no-color -out=plan.tfplan

      - name: Terraform Apply
        id: apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: terraform apply -auto-approve -input=false

      - name: Terraform Apply Summary
        if: always()
        run: |
          if [ "${{ steps.apply.outcome }}" = "success" ]; then
            echo "Terraform apply succeeded." >> $GITHUB_STEP_SUMMARY
          else
            echo "Terraform apply failed." >> $GITHUB_STEP_SUMMARY
          fi

      - name: Terraform Plan Summary
        uses: ./.github/actions/terraform-plan-summary
        with:
          plan_file: 'plan.tfplan'
          job_name: 'Oracle'

  tailscale-setup:
    name: "Ansible Tailscale"
    needs: [changes, oracle-setup, gcp-setup]
    if: |
      !cancelled() &&
      (needs.oracle-setup.result == 'success' || needs.oracle-setup.result == 'skipped') &&
      (needs.gcp-setup.result == 'success' || needs.gcp-setup.result == 'skipped') &&
      (needs.changes.outputs.ansible == 'true' || github.event_name == 'push')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: ./ansible

    steps:
      - name: Check out the codebase
        uses: actions/checkout@v5
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Ansible Environment
        uses: ./.github/actions/setup-ansible
        with:
          tailscale_client_id: ${{ secrets.TAILSCALE_CLIENT_ID }}
          tailscale_client_secret: ${{ secrets.TAILSCALE_CLIENT_SECRET }}
          ssh_private_key: ${{ secrets.SSH_AUTH_PRIVATE_KEY }}
          ansible_vault_password: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}

      - name: Dry-run check (PR only)
        if: github.event_name == 'pull_request'
        id: dry_run
        continue-on-error: true
        run: |
          echo "## ðŸ” Ansible Dry-Run Preview" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # Detect which playbooks have changes
          PIS_CHANGED=false
          VPN_CHANGED=false
          K3S_CHANGED=false
          SECURITY_CHANGED=false
          HOSTS_INI_CHANGED=false

          # Check if hosts.ini changed (important for Tailscale SSH migration)
          if git diff --name-only origin/main...HEAD | grep -E '^ansible/hosts\.ini'; then
            HOSTS_INI_CHANGED=true
            echo "### âš ï¸ hosts.ini Changed - Testing Connectivity" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Testing Ansible connectivity to all nodes via Tailscale SSH..." >> $GITHUB_STEP_SUMMARY
            ansible all -i hosts.ini -m ping --one-line 2>&1 | tee connectivity_test.log || true
            cat connectivity_test.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          if git diff --name-only origin/main...HEAD | grep -E '^ansible/(playbooks/pis\.yml|roles/(common|network)/|group_vars/pis\.yml)'; then
            PIS_CHANGED=true
          fi

          if git diff --name-only origin/main...HEAD | grep -E '^ansible/(vpn\.yml|confs/)'; then
            VPN_CHANGED=true
          fi

          if git diff --name-only origin/main...HEAD | grep -E '^ansible/(playbooks/security\.yml|roles/(fail2ban|firewall)/|group_vars/public_nodes\.yml)'; then
            SECURITY_CHANGED=true
          fi

          if git diff --name-only origin/main...HEAD | grep -E '^ansible/(k3s\.yml|k3s-master-config\.yaml|roles/k3s[^/]+/|playbooks/k3s\.yml)'; then
            K3S_CHANGED=true
          fi

          # If hosts.ini changed, also run a basic dry-run on at least one playbook to verify end-to-end
          if [ "$HOSTS_INI_CHANGED" = true ]; then
            echo "### End-to-End Connectivity Test" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Running dry-run on a sample node to verify Tailscale SSH works end-to-end..." >> $GITHUB_STEP_SUMMARY
            # Try to run a dry-run on a simple playbook or just test with a single node
            if [ -f playbooks/pis.yml ]; then
              ansible-playbook -i hosts.ini playbooks/pis.yml --check --limit michael-pi 2>&1 | head -20 | tee e2e_test.log || true
            elif [ -f vpn.yml ]; then
              ansible-playbook -i hosts.ini vpn.yml --check --limit pam-amd1 2>&1 | head -20 | tee e2e_test.log || true
            else
              echo "No playbooks found for end-to-end test" >> e2e_test.log
            fi
            cat e2e_test.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
          fi

          # Check pis playbook only if related files changed
          if [ "$PIS_CHANGED" = true ] && [ -f playbooks/pis.yml ]; then
            echo "### Pis Playbook Check" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Running syntax check only (--check without --diff to protect sensitive content)" >> $GITHUB_STEP_SUMMARY
            ansible-playbook -i hosts.ini playbooks/pis.yml \
              --check 2>&1 | tee dry_run.log || true
            cat dry_run.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "â­ï¸ Pis playbook - no changes detected, skipping dry-run" >> $GITHUB_STEP_SUMMARY
          fi

          # Check vpn playbook only if related files changed
          if [ "$VPN_CHANGED" = true ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### VPN Playbook Check" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Running syntax check only (--check without --diff to protect vault-encrypted content)" >> $GITHUB_STEP_SUMMARY
            ansible-playbook -i hosts.ini vpn.yml \
              --vault-password-file ./vault.pass --check 2>&1 | tee vpn_dry_run.log || true
            cat vpn_dry_run.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â­ï¸ VPN playbook - no changes detected, skipping dry-run" >> $GITHUB_STEP_SUMMARY
          fi

          # Check k3s playbook only if related files changed
          if [ "$K3S_CHANGED" = true ] && [ -f k3s.yml ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### k3s Playbook Check" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Running syntax check only (--check without --diff to protect sensitive content)" >> $GITHUB_STEP_SUMMARY
            ansible-playbook -i hosts.ini k3s.yml \
              --vault-password-file ./vault.pass --check 2>&1 | tee k3s_dry_run.log || true
            cat k3s_dry_run.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â­ï¸ k3s playbook - no changes detected, skipping dry-run" >> $GITHUB_STEP_SUMMARY
          fi

          # Check security playbook only if related files changed
          if [ "$SECURITY_CHANGED" = true ] && [ -f playbooks/security.yml ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Security Playbook Check" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
            echo "Running syntax check for fail2ban and firewall deployment" >> $GITHUB_STEP_SUMMARY
            ansible-playbook -i hosts.ini playbooks/security.yml \
              --check 2>&1 | tee security_dry_run.log || true
            cat security_dry_run.log >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "â­ï¸ Security playbook - no changes detected, skipping dry-run" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Run vpn-playbook
        id: vpn_playbook
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          ansible-playbook -i hosts.ini vpn.yml --vault-password-file ./vault.pass

      - name: vpn-playbook Summary
        if: always()
        run: |
          if [ "${{ steps.vpn_playbook.outcome }}" = "success" ]; then
            echo "âœ… vpn-playbook succeeded." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.vpn_playbook.outcome }}" = "skipped" ]; then
            echo "â­ï¸ vpn-playbook skipped (PR dry-run only)." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ vpn-playbook failed." >> $GITHUB_STEP_SUMMARY
          fi

  pis-setup:
    name: "Ansible Pis"
    needs: [changes, tailscale-setup]
    if: |
      !cancelled() &&
      (needs.tailscale-setup.result == 'success' || needs.tailscale-setup.result == 'skipped') &&
      (
        needs.changes.outputs.ansible == 'true' ||
        github.event_name == 'push' ||
        github.event_name == 'workflow_dispatch'
      ) &&
      (
        github.event_name == 'workflow_dispatch' ||
        (github.ref == 'refs/heads/main' && github.event_name == 'push')
      )
    runs-on: ubuntu-latest
    timeout-minutes: 60
    defaults:
      run:
        working-directory: ./ansible

    steps:
      - name: Check out the codebase
        uses: actions/checkout@v5
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Ansible Environment
        uses: ./.github/actions/setup-ansible
        with:
          tailscale_client_id: ${{ secrets.TAILSCALE_CLIENT_ID }}
          tailscale_client_secret: ${{ secrets.TAILSCALE_CLIENT_SECRET }}
          ssh_private_key: ${{ secrets.SSH_AUTH_PRIVATE_KEY }}

      - name: Run pis-playbook
        id: pis_playbook
        if: |
          (github.event_name == 'push' && github.ref == 'refs/heads/main') ||
          (github.event_name == 'workflow_dispatch')
        env:
          TAILSCALE_JOIN_KEY: ${{ secrets.TAILSCALE_JOIN_KEY }}
        run: |
          ansible-playbook -i hosts.ini playbooks/pis.yml

      - name: pis-playbook Summary
        if: always()
        run: |
          if [ "${{ steps.pis_playbook.outcome }}" = "success" ]; then
            echo "âœ… pis-playbook succeeded." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.pis_playbook.outcome }}" = "skipped" ]; then
            echo "â­ï¸ pis-playbook skipped (PR dry-run only)." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ pis-playbook failed." >> $GITHUB_STEP_SUMMARY
          fi

  security-setup:
    name: "Ansible Security (Public Nodes)"
    needs: [changes, tailscale-setup]
    if: |
      !cancelled() &&
      (needs.tailscale-setup.result == 'success' || needs.tailscale-setup.result == 'skipped') &&
      (needs.changes.outputs.ansible == 'true' || github.event_name == 'push') &&
      (github.event_name == 'workflow_dispatch' ||
       (github.ref == 'refs/heads/main' && github.event_name == 'push'))
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: ./ansible

    steps:
      - name: Check out the codebase
        uses: actions/checkout@v5
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Ansible Environment
        uses: ./.github/actions/setup-ansible
        with:
          tailscale_client_id: ${{ secrets.TAILSCALE_CLIENT_ID }}
          tailscale_client_secret: ${{ secrets.TAILSCALE_CLIENT_SECRET }}
          ssh_private_key: ${{ secrets.SSH_AUTH_PRIVATE_KEY }}
          ansible_vault_password: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}

      - name: Run security-playbook
        id: security_playbook
        if: github.event_name == 'push' && github.ref == 'refs/heads/main'
        run: |
          ansible-playbook -i hosts.ini playbooks/security.yml

      - name: security-playbook Summary
        if: always()
        run: |
          if [ "${{ steps.security_playbook.outcome }}" = "success" ]; then
            echo "âœ… security-playbook succeeded." >> $GITHUB_STEP_SUMMARY
          elif [ "${{ steps.security_playbook.outcome }}" = "skipped" ]; then
            echo "â­ï¸ security-playbook skipped (PR dry-run only)." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ security-playbook failed." >> $GITHUB_STEP_SUMMARY
          fi

  k3s-setup:
    name: "Ansible K3S"
    needs: [changes, pis-setup]
    if: |
      !cancelled() &&
      (needs.pis-setup.result == 'success' || needs.pis-setup.result == 'skipped') &&
      (needs.changes.outputs.ansible == 'true' || github.event_name == 'push') &&
      (github.event_name == 'workflow_dispatch' ||
       (github.ref == 'refs/heads/main' && github.event_name == 'push'))
    runs-on: ubuntu-latest
    timeout-minutes: 45
    defaults:
      run:
        working-directory: ./ansible

    steps:
      - name: Check out the codebase
        uses: actions/checkout@v5
        with:
          submodules: true
          fetch-depth: 0

      - name: Setup Ansible Environment
        uses: ./.github/actions/setup-ansible
        with:
          tailscale_client_id: ${{ secrets.TAILSCALE_CLIENT_ID }}
          tailscale_client_secret: ${{ secrets.TAILSCALE_CLIENT_SECRET }}
          ssh_private_key: ${{ secrets.SSH_AUTH_PRIVATE_KEY }}
          ansible_vault_password: ${{ secrets.ANSIBLE_VAULT_PASSWORD }}

      - name: Run k3s-playbook
        id: k3s_playbook
        env:
          TAILSCALE_JOIN_KEY: ${{ secrets.TAILSCALE_JOIN_KEY }}
        run: |
          ansible-playbook -i hosts.ini k3s.yml --vault-password-file ./vault.pass

      - name: k3s-playbook Summary
        if: always()
        run: |
          if [ "${{ steps.k3s_playbook.outcome }}" = "success" ]; then
            echo "k3s-playbook succeeded." >> $GITHUB_STEP_SUMMARY
          else
            echo "k3s-playbook failed." >> $GITHUB_STEP_SUMMARY
          fi

  run-k3s:
    name: "Terraform K8S"
    needs: [changes, lint, k3s-setup]
    if: |
      !cancelled() &&
      (needs.k3s-setup.result == 'success' || needs.k3s-setup.result == 'skipped') &&
      github.ref != 'refs/heads/staging' &&
      (needs.changes.outputs.kubernetes == 'true' || github.event_name == 'push')
    runs-on: ubuntu-latest
    timeout-minutes: 30
    defaults:
      run:
        working-directory: ./kubernetes
    env:
      TF_PLUGIN_CACHE_DIR: ~/.terraform.d/plugin-cache
      TF_VAR_cloudflare_api_token: ${{ secrets.TF_CLOUDFLARE_API_TOKEN }}
      TF_VAR_kube_client_cert: ${{ secrets.TF_KUBE_CLIENT_CERT }}
      TF_VAR_kube_client_key: ${{ secrets.TF_KUBE_CLIENT_KEY }}
      TF_VAR_kube_cluster_ca_cert: ${{ secrets.TF_KUBE_CLUSTER_CA_CERT }}
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0  # Full history needed for pre-commit diffs (until PR #285 merges)

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_version: "1.9.6"

      - name: Setup and Run Pre-commit
        uses: ./.github/actions/setup-precommit

      # Cache Terraform plugins and initialization files
      # Note: .terraform.lock.hcl is excluded from cache to avoid restore-keys
      # overwriting the tracked lock file with stale provider versions
      - name: Cache Terraform
        uses: actions/cache@v4
        with:
          path: |
            ~/.terraform.d/plugin-cache
            kubernetes/.terraform
          key: ${{ runner.os }}-terraform-k8s-${{ hashFiles('**/*.tf', '**/.terraform.lock.hcl') }}
          restore-keys: |
            ${{ runner.os }}-terraform-k8s-

      - name: Create plugin cache directory
        run: mkdir -p ~/.terraform.d/plugin-cache

      - name: Terraform Format
        id: fmt
        run: terraform fmt -check

      - name: Terraform Init
        run: terraform init

      - name: Terraform Validate
        run: terraform validate

      - name: "Terraform Plan"
        id: plan
        run: terraform plan -no-color -out=plan.tfplan

      - name: Terraform Apply
        id: apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: terraform apply -auto-approve -input=false

      - name: Terraform Apply Summary
        if: always()
        run: |
          if [ "${{ steps.apply.outcome }}" = "success" ]; then
            echo "Terraform apply succeeded." >> $GITHUB_STEP_SUMMARY
          else
            echo "Terraform apply failed." >> $GITHUB_STEP_SUMMARY
          fi

      # Add drift detection (guarded to post-apply on main) with safe exit-code capture
      - name: Check for Infrastructure Drift
        id: drift_check
        if: github.ref == 'refs/heads/main' && github.event_name == 'push' && steps.apply.outcome == 'success'
        run: |
          # plan exit codes: 0=no change, 1=error, 2=changes (drift)
          set +e
          terraform plan -detailed-exitcode -out=drift.tfplan
          code=$?
          set -e
          if [ "$code" -eq 1 ]; then
            echo "Terraform plan encountered an error (exit 1)."
            exit 1
          fi
          echo "drift_exitcode=$code" >> "$GITHUB_OUTPUT"

      - name: Drift Detection Summary
        if: always() && github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          exitcode="${{ steps.drift_check.outputs.drift_exitcode }}"
          if [ -z "$exitcode" ]; then
            echo "Drift detection did not run (non-main or apply skipped)." >> $GITHUB_STEP_SUMMARY
          elif [ "$exitcode" -eq 0 ]; then
            echo "Drift detection: no changes detected." >> $GITHUB_STEP_SUMMARY
          elif [ "$exitcode" -eq 2 ]; then
            echo "Drift detection: configuration drift detected." >> $GITHUB_STEP_SUMMARY
          else
            echo "Drift detection completed with unexpected exit code: $exitcode" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Terraform Plan Summary
        uses: ./.github/actions/terraform-plan-summary
        with:
          plan_file: 'plan.tfplan'
          job_name: 'Kubernetes'

  tailscale-apply:
    name: "Terraform Tailscale ACL"
    needs: [changes, lint]
    if: |
      !cancelled() &&
      (needs.changes.outputs.tailscale == 'true' || github.event_name == 'push')
    runs-on: ubuntu-latest
    timeout-minutes: 15
    defaults:
      run:
        working-directory: ./terraform/tailscale
    steps:
      - name: Checkout
        uses: actions/checkout@v5
        with:
          fetch-depth: 0

      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3.1.2
        with:
          cli_config_credentials_token: ${{ secrets.TF_API_TOKEN }}
          terraform_version: "1.9.6"

      - name: Terraform Init
        run: terraform init

      - name: Terraform Plan
        run: |
          terraform plan -out=plan-tailscale.tfplan \
            -var="tailscale_api_key=${{ secrets.TS_API_KEY }}"

      - name: Terraform Plan Summary
        uses: ./.github/actions/terraform-plan-summary
        with:
          plan_file: 'plan-tailscale.tfplan'
          job_name: 'Tailscale ACL'

      - name: Terraform Apply
        if: github.ref == 'refs/heads/main' && github.event_name == 'push'
        run: |
          terraform apply -auto-approve plan-tailscale.tfplan

      - name: Tailscale ACL Summary
        if: always()
        run: |
          if [ "${{ job.status }}" = "success" ]; then
            echo "âœ… Tailscale ACL apply succeeded." >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ Tailscale ACL apply failed." >> $GITHUB_STEP_SUMMARY
          fi
