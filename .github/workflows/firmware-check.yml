---
name: Check Pi Firmware Updates

on:
  schedule:
    - cron: '0 9 * * 1'  # Every Monday at 9am UTC
  workflow_dispatch:  # Allow manual trigger

permissions:
  contents: read
  issues: write

jobs:
  check-firmware:
    name: Check for new Pi firmware
    runs-on: ubuntu-latest
    steps:
      - name: Get latest rpi-eeprom release
        id: latest
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          LATEST=$(gh api repos/raspberrypi/rpi-eeprom/releases/latest --jq '.tag_name')
          RELEASE_DATE=$(gh api repos/raspberrypi/rpi-eeprom/releases/latest --jq '.published_at')
          RELEASE_URL=$(gh api repos/raspberrypi/rpi-eeprom/releases/latest --jq '.html_url')
          echo "version=$LATEST" >> $GITHUB_OUTPUT
          echo "date=$RELEASE_DATE" >> $GITHUB_OUTPUT
          echo "url=$RELEASE_URL" >> $GITHUB_OUTPUT
          echo "Latest release: $LATEST ($RELEASE_DATE)"

      - name: Check for existing issue
        id: existing
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          # Search for open issues with this version in the title
          EXISTING=$(gh issue list --repo ${{ github.repository }} --state open --search "Pi firmware update: ${{ steps.latest.outputs.version }} in:title" --json number --jq 'length')
          echo "count=$EXISTING" >> $GITHUB_OUTPUT
          if [ "$EXISTING" -gt 0 ]; then
            echo "Issue already exists for version ${{ steps.latest.outputs.version }}"
          fi

      - name: Create issue for new firmware
        if: steps.existing.outputs.count == '0'
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          gh issue create \
            --repo ${{ github.repository }} \
            --title "Pi firmware update: ${{ steps.latest.outputs.version }}" \
            --body "$(cat <<'EOF'
          ## New Raspberry Pi Firmware Available

          **Version:** ${{ steps.latest.outputs.version }}
          **Released:** ${{ steps.latest.outputs.date }}
          **Release notes:** ${{ steps.latest.outputs.url }}

          ### To update firmware:

          1. Go to **Actions** â†’ **CI/CD** workflow
          2. Click **Run workflow**
          3. Check **"Run Pi firmware checks"**
          4. Click **Run workflow**

          The firmware role will:
          - Check each Pi for available updates
          - Apply updates if available
          - Reboot Pis if needed

          ### Manual alternative:

          ```bash
          cd ansible
          ansible-playbook -i hosts.ini playbooks/pis.yml -e "firmware_upgrade_enabled=true"
          ```

          ---
          *This issue was automatically created by the firmware check workflow.*
          EOF
          )"

      - name: Summary
        run: |
          echo "## Firmware Check Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Latest version:** ${{ steps.latest.outputs.version }}" >> $GITHUB_STEP_SUMMARY
          echo "**Released:** ${{ steps.latest.outputs.date }}" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.existing.outputs.count }}" -gt 0 ]; then
            echo "**Status:** Issue already exists" >> $GITHUB_STEP_SUMMARY
          else
            echo "**Status:** New issue created" >> $GITHUB_STEP_SUMMARY
          fi
