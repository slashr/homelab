---

- name: Initialising cluster
  hosts: workers
  become: true
  tasks:
    - name: Updating instances
      ansible.builtin.apt:
        update_cache: true
        upgrade: dist

    - name: Downloading k3s script
      ansible.builtin.get_url:
        url: https://get.k3s.io
        dest: /tmp/k3s.sh
        mode: "0555"

- name: Starting K3S Agent
  hosts: workers
  become: true
  tasks:
    - name: Installing k3s
      ansible.builtin.script: /tmp/k3s.sh
      environment:
        K3S_URL: "https://130.61.64.164:6443"
        K3S_TOKEN: "K10a338dc6c873ea250faca274a6f3b1f097a1201e8b1de4f42b5421f1eb9582886::server:548163aa2312d8a670ce1522d8ce5653"
    - name: Sleep for 10 seconds
      ansible.builtin.wait_for:
        timeout: 10
    - name: Check if service is running
      ansible.builtin.systemd:
        name: k3s-agent
        state: stopped
        enabled: true
      notify:
        - Restart k3s-agent
  handlers:
    - name: Restart k3s-agent
      ansible.builtin.systemd:
        name: k3s-agent
        state: restarted

- name: Enabling Nodes
  hosts: cretus
  become: true
  tasks:
    - name: Sleep for 10 seconds
      ansible.builtin.wait_for:
        timeout: 10
    - name: Adding role to worker node arm1
      ansible.builtin.command: kubectl label node arm1 kubernetes.io/role=worker
      changed_when: false
    - name: Adding role to worker node arm2
      ansible.builtin.command: kubectl label node arm2 kubernetes.io/role=worker
      changed_when: false
    - name: Adding role to worker node amd2
      ansible.builtin.command: kubectl label node amd2 kubernetes.io/role=worker
      changed_when: false
