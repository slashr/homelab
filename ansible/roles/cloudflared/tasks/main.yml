---
# Install and configure cloudflared for Cloudflare Tunnel HA

- name: Cloudflared disabled
  ansible.builtin.debug:
    msg: "Cloudflared configuration skipped (cloudflared_enabled=false)."
  when: not (cloudflared_enabled | default(true) | bool)
  tags: [cloudflared]

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - cloudflared_tunnel_token | length > 0
    fail_msg: "cloudflared_tunnel_token must be set (from Terraform output)"
  when: cloudflared_enabled | default(true) | bool
  tags: [cloudflared]

- block:
    - name: Add Cloudflare GPG key
      ansible.builtin.apt_key:
        url: https://pkg.cloudflare.com/cloudflare-main.gpg
        keyring: /usr/share/keyrings/cloudflare-main.gpg
        state: present
      tags: [cloudflared]

    - name: Add Cloudflare repository
      ansible.builtin.apt_repository:
        repo: "deb [signed-by=/usr/share/keyrings/cloudflare-main.gpg] https://pkg.cloudflare.com/cloudflared {{ ansible_distribution_release }} main"
        filename: cloudflared
        state: present
      tags: [cloudflared]

    - name: Install cloudflared
      ansible.builtin.apt:
        name: cloudflared
        state: present
        update_cache: true
      tags: [cloudflared]

    - name: Create cloudflared systemd service
      ansible.builtin.template:
        src: cloudflared.service.j2
        dest: /etc/systemd/system/cloudflared.service
        owner: root
        group: root
        mode: "0644"
      register: cloudflared_service_file
      notify: restart cloudflared
      tags: [cloudflared]

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true
      when: cloudflared_service_file.changed
      tags: [cloudflared]

    - name: Enable and start cloudflared service
      ansible.builtin.systemd:
        name: cloudflared
        enabled: true
        state: started
      tags: [cloudflared]

    - name: Verify cloudflared is running
      ansible.builtin.command: systemctl is-active cloudflared
      register: cloudflared_status
      changed_when: false
      failed_when: cloudflared_status.stdout != "active"
      tags: [cloudflared]

    - name: Display cloudflared status
      ansible.builtin.debug:
        msg: "Cloudflared is {{ cloudflared_status.stdout }}"
      tags: [cloudflared]

  when: cloudflared_enabled | default(true) | bool
