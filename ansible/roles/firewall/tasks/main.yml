---
# UFW Firewall Configuration for Public Cloud Nodes
# Adds rate limiting for SSH and restricts k3s traffic to Tailscale network

- name: Check for ufw binary
  ansible.builtin.command: command -v ufw
  register: ufw_binary_check
  changed_when: false
  failed_when: false
  become: true
  tags: [firewall, ufw]

- name: Install UFW (if missing)
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: true
  environment:
    DEBIAN_FRONTEND: noninteractive
  become: true
  register: ufw_install
  retries: 3
  delay: 5
  until: ufw_install is success
  when: ufw_binary_check.rc != 0
  tags: [firewall, ufw]

# iptables-persistent conflicts with UFW on Debian Trixie - skip on Trixie
- name: Preseed iptables-persistent to skip interactive prompts
  ansible.builtin.debconf:
    name: iptables-persistent
    question: "{{ item }}"
    value: "false"
    vtype: boolean
  loop:
    - iptables-persistent/autosave_v4
    - iptables-persistent/autosave_v6
  become: true
  when: not (ansible_distribution == "Debian" and ansible_distribution_release == "trixie")
  tags: [firewall, ufw]

- name: Install iptables-persistent (not on Debian Trixie - conflicts with UFW)
  ansible.builtin.apt:
    name: iptables-persistent
    state: present
  environment:
    DEBIAN_FRONTEND: noninteractive
  become: true
  register: iptables_persistent_install
  when: not (ansible_distribution == "Debian" and ansible_distribution_release == "trixie")
  tags: [firewall, ufw]

- name: Reset UFW to default state
  community.general.ufw:
    state: reset
  become: true
  tags: [firewall, ufw]

- name: Set UFW default incoming policy to deny
  community.general.ufw:
    default: deny
    direction: incoming
  become: true
  tags: [firewall, ufw]

- name: Set UFW default outgoing policy to allow
  community.general.ufw:
    default: allow
    direction: outgoing
  become: true
  tags: [firewall, ufw]

- name: Set UFW default routed/forward policy to allow (required for k3s)
  community.general.ufw:
    default: allow
    direction: routed
  become: true
  tags: [firewall, ufw]

- name: Allow Tailscale (41641/udp) - MUST be before enabling firewall
  community.general.ufw:
    rule: allow
    port: '41641'
    proto: udp
  become: true
  tags: [firewall, ufw]

- name: Allow SSH with rate limiting (22/tcp) - max 6 connections per 30s
  community.general.ufw:
    rule: limit
    port: '22'
    proto: tcp
  become: true
  tags: [firewall, ufw]

- name: Allow k3s API server (6443/tcp) from Tailscale network only
  community.general.ufw:
    rule: allow
    port: '6443'
    proto: tcp
    from_ip: "{{ tailscale_network_cidr }}"
  become: true
  tags: [firewall, ufw]

- name: Allow kubelet (10250/tcp) from Tailscale network only
  community.general.ufw:
    rule: allow
    port: '10250'
    proto: tcp
    from_ip: "{{ tailscale_network_cidr }}"
  become: true
  tags: [firewall, ufw]

- name: Allow k3s metrics (10251/tcp) from Tailscale network only
  community.general.ufw:
    rule: allow
    port: '10251'
    proto: tcp
    from_ip: "{{ tailscale_network_cidr }}"
  become: true
  tags: [firewall, ufw]

# Allow pod/service CIDRs so cross-node traffic isn't blocked by ufw-not-local
- name: Allow pod network (10.42.0.0/16) from cluster
  community.general.ufw:
    rule: allow
    from_ip: "{{ pod_network_cidr }}"
  become: true
  tags: [firewall, ufw]

- name: Allow pod network (10.42.0.0/16) to cluster
  community.general.ufw:
    rule: allow
    to_ip: "{{ pod_network_cidr }}"
  become: true
  tags: [firewall, ufw]

- name: Allow service network (10.43.0.0/16) from cluster
  community.general.ufw:
    rule: allow
    from_ip: "{{ service_network_cidr }}"
  become: true
  tags: [firewall, ufw]

- name: Allow service network (10.43.0.0/16) to cluster
  community.general.ufw:
    rule: allow
    to_ip: "{{ service_network_cidr }}"
  become: true
  tags: [firewall, ufw]

- name: Enable UFW (forced, non-interactive)
  community.general.ufw:
    state: enabled
  become: true
  tags: [firewall, ufw]

- name: Verify UFW is active
  ansible.builtin.command: ufw status verbose
  register: ufw_status
  changed_when: false
  become: true
  tags: [firewall, ufw]

- name: Display UFW status
  ansible.builtin.debug:
    var: ufw_status.stdout_lines
  tags: [firewall, ufw]

- name: Verify Tailscale connectivity (ping k3s master)
  ansible.builtin.command: ping -c 3 {{ k3s_master_ip }}
  register: tailscale_ping
  changed_when: false
  failed_when: false
  tags: [firewall, ufw]

- name: Display Tailscale connectivity status
  ansible.builtin.debug:
    msg: "Tailscale connectivity: {{ 'OK' if tailscale_ping.rc == 0 else 'FAILED - Check Tailscale!' }}"
  tags: [firewall, ufw]
