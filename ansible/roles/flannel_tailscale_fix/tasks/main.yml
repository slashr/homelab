---
# Flannel Tailscale routing fix
#
# Deploys a systemd service that fixes routing issues when using
# flannel with the Tailscale backend. The fix:
# 1. Removes /16 supernet routes from table 52 (they override local cni0 routes)
# 2. Adds MASQUERADE for cross-node pod traffic going via tailscale0

- name: Flannel Tailscale fix disabled
  ansible.builtin.debug:
    msg: "Flannel Tailscale fix is disabled (flannel_tailscale_fix_enabled=false)"
  when: not (flannel_tailscale_fix_enabled | default(true) | bool)
  tags: [flannel_tailscale_fix]

- name: Deploy flannel Tailscale fix
  when: flannel_tailscale_fix_enabled | default(true) | bool
  block:
    - name: Deploy flannel Tailscale fix script
      ansible.builtin.template:
        src: flannel-tailscale-fix.sh.j2
        dest: /usr/local/bin/flannel-tailscale-fix.sh
        owner: root
        group: root
        mode: "0755"
      tags: [flannel_tailscale_fix]

    - name: Deploy flannel Tailscale fix systemd service
      ansible.builtin.template:
        src: flannel-tailscale-fix.service.j2
        dest: /etc/systemd/system/flannel-tailscale-fix.service
        owner: root
        group: root
        mode: "0644"
      register: flannel_fix_service
      tags: [flannel_tailscale_fix]

    - name: Reload systemd daemon
      ansible.builtin.systemd:
        daemon_reload: true
      when: flannel_fix_service.changed
      tags: [flannel_tailscale_fix]

    - name: Enable flannel Tailscale fix service
      ansible.builtin.systemd:
        name: flannel-tailscale-fix
        enabled: true
      tags: [flannel_tailscale_fix]

    - name: Run flannel Tailscale fix now
      ansible.builtin.command: /usr/local/bin/flannel-tailscale-fix.sh
      register: flannel_fix_result
      changed_when: flannel_fix_result.rc == 0
      failed_when: false
      tags: [flannel_tailscale_fix]

    - name: Display fix result
      ansible.builtin.debug:
        msg: "{{ flannel_fix_result.stdout_lines | default(['No output']) }}"
      when: flannel_fix_result.stdout_lines | default([]) | length > 0
      tags: [flannel_tailscale_fix]
  tags: [flannel_tailscale_fix]
