---
# WiFi Power Save Configuration
# Now that Pis use ethernet as primary (metric 100), WiFi power save is safe to enable.
# WiFi serves as backup only (metric 600), so latency from power save won't affect k3s.

- name: Check if NetworkManager is active
  ansible.builtin.systemd:
    name: NetworkManager
  register: nm_status
  failed_when: false
  tags:
    - wifi
    - dns

- name: Check if dhcpcd is active
  ansible.builtin.systemd:
    name: dhcpcd
  register: dhcpcd_status
  failed_when: false
  tags:
    - wifi
    - dns

- name: Configure WiFi power save via NetworkManager
  ansible.builtin.copy:
    dest: /etc/NetworkManager/conf.d/wifi-powersave.conf
    content: |
      [connection]
      # 2 = disable, 3 = enable
      wifi.powersave = {{ 3 if wifi_power_save_enabled | default(false) else 2 }}
    mode: '0644'
  become: true
  when: nm_status.status is defined and nm_status.status.ActiveState == "active"
  notify: Restart NetworkManager
  tags: wifi

- name: Configure WiFi power save via dhcpcd hook
  ansible.builtin.copy:
    dest: /etc/dhcpcd.enter-hook
    content: |
      #!/bin/sh
      # Configure WiFi power management
      if [ "$interface" = "wlan0" ]; then
          /sbin/iwconfig wlan0 power {{ 'on' if wifi_power_save_enabled | default(false) else 'off' }} 2>/dev/null || true
      fi
    mode: '0755'
  become: true
  when: dhcpcd_status.status is defined and dhcpcd_status.status.ActiveState == "active"
  notify: Restart dhcpcd
  tags: wifi

- name: Apply WiFi power save setting (runtime)
  ansible.builtin.command: iwconfig wlan0 power {{ 'on' if wifi_power_save_enabled | default(false) else 'off' }}
  become: true
  when: not ansible_check_mode
  register: iwconfig_result
  changed_when: iwconfig_result.rc == 0
  failed_when: false
  tags: wifi

# DNS Configuration - AdGuard on dwight-pi with fallbacks
- name: Configure DNS servers
  ansible.builtin.template:
    src: ../templates/resolv.conf.j2
    dest: /etc/resolv.conf
    mode: '0644'
  become: true
  tags: dns

- name: Prevent dhcpcd from overwriting resolv.conf
  ansible.builtin.lineinfile:
    path: /etc/dhcpcd.conf
    line: 'nohook resolv.conf'
    create: true
    mode: '0644'
  become: true
  when: dhcpcd_status.status is defined and dhcpcd_status.status.ActiveState == "active"
  tags: dns

- name: Prevent NetworkManager from overwriting resolv.conf
  ansible.builtin.copy:
    dest: /etc/NetworkManager/conf.d/dns.conf
    content: |
      [main]
      dns=none
    mode: '0644'
  become: true
  when: nm_status.status is defined and nm_status.status.ActiveState == "active"
  notify: Restart NetworkManager
  tags: dns

# NTP Configuration - Ensure time synchronization
- name: Enable and start systemd-timesyncd
  ansible.builtin.systemd:
    name: systemd-timesyncd
    enabled: true
    state: started
  become: true
  tags: ntp

- name: Configure NTP servers
  ansible.builtin.copy:
    dest: /etc/systemd/timesyncd.conf
    content: |
      [Time]
      NTP=0.pool.ntp.org 1.pool.ntp.org 2.pool.ntp.org 3.pool.ntp.org
      FallbackNTP=time.cloudflare.com time.google.com
    mode: '0644'
  become: true
  notify: Restart timesyncd
  tags: ntp

- name: Set timezone to Europe/Berlin
  community.general.timezone:
    name: Europe/Berlin
  become: true
  tags: ntp
