---
# UFW Firewall Configuration for Raspberry Pis
# Configures firewall rules to allow k3s, SSH, and Tailscale traffic

- name: Install UFW
  ansible.builtin.apt:
    name: ufw
    state: present
    update_cache: true
  become: true
  tags: [firewall, ufw]

- name: Reset UFW to default state
  community.general.ufw:
    state: reset
  become: true
  tags: [firewall, ufw]

- name: Set UFW default incoming policy to deny
  community.general.ufw:
    default: deny
    direction: incoming
  become: true
  tags: [firewall, ufw]

- name: Set UFW default outgoing policy to allow
  community.general.ufw:
    default: allow
    direction: outgoing
  become: true
  tags: [firewall, ufw]

- name: Allow SSH (22/tcp) - CRITICAL to avoid lockout
  community.general.ufw:
    rule: allow
    port: '22'
    proto: tcp
  become: true
  tags: [firewall, ufw]

- name: Allow Tailscale (41641/udp)
  community.general.ufw:
    rule: allow
    port: '41641'
    proto: udp
  become: true
  tags: [firewall, ufw]

- name: Allow k3s API server (6443/tcp) from Tailscale network
  community.general.ufw:
    rule: allow
    port: '6443'
    proto: tcp
    from_ip: 100.100.0.0/16
  become: true
  tags: [firewall, ufw]

- name: Allow kubelet (10250/tcp) from Tailscale network
  community.general.ufw:
    rule: allow
    port: '10250'
    proto: tcp
    from_ip: 100.100.0.0/16
  become: true
  tags: [firewall, ufw]

- name: Allow k3s node metrics (10250/tcp) from Tailscale network
  community.general.ufw:
    rule: allow
    port: '10251'
    proto: tcp
    from_ip: 100.100.0.0/16
  become: true
  tags: [firewall, ufw]

- name: Allow k3s flannel VXLAN (8472/udp) from Tailscale network
  community.general.ufw:
    rule: allow
    port: '8472'
    proto: udp
    from_ip: 100.100.0.0/16
  become: true
  tags: [firewall, ufw]

# Special handling for dwight-pi (Pi-hole server)
- name: Check if this is the Pi-hole server (dwight-pi)
  ansible.builtin.set_fact:
    is_pihole_server: "{{ inventory_hostname == 'dwight-pi' }}"
  tags: [firewall, ufw]

- name: Allow Pi-hole DNS (53/tcp) from local network
  community.general.ufw:
    rule: allow
    port: '53'
    proto: tcp
    from_ip: 192.168.1.0/24
  become: true
  when: is_pihole_server | bool
  tags: [firewall, ufw, pihole]

- name: Allow Pi-hole DNS (53/udp) from local network
  community.general.ufw:
    rule: allow
    port: '53'
    proto: udp
    from_ip: 192.168.1.0/24
  become: true
  when: is_pihole_server | bool
  tags: [firewall, ufw, pihole]

- name: Allow Pi-hole admin UI (80/tcp) from local network
  community.general.ufw:
    rule: allow
    port: '80'
    proto: tcp
    from_ip: 192.168.1.0/24
  become: true
  when: is_pihole_server | bool
  tags: [firewall, ufw, pihole]

- name: Enable UFW
  community.general.ufw:
    state: enabled
  become: true
  tags: [firewall, ufw]

- name: Verify UFW is active
  ansible.builtin.command: ufw status verbose
  register: ufw_status
  changed_when: false
  become: true
  tags: [firewall, ufw]

- name: Display UFW status
  ansible.builtin.debug:
    var: ufw_status.stdout_lines
  tags: [firewall, ufw]

