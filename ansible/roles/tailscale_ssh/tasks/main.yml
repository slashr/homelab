---
# Ensures Tailscale SSH is properly configured on the host
# This role should run BEFORE any roles that may reboot the host
#
# When using tags (--advertise-tags), nodes may need re-authentication
# after reboots. This role handles that automatically using an auth key.

- name: Tailscale SSH disabled
  ansible.builtin.debug:
    msg: "Tailscale SSH configuration skipped (tailscale_ssh_enabled=false)."
  when: not (tailscale_ssh_enabled | default(true) | bool)
  tags: [tailscale_ssh]

- name: Validate required variables
  ansible.builtin.assert:
    that:
      - tailscale_ssh_tag | length > 0
    fail_msg: "tailscale_ssh_tag must be set (e.g., 'tag:pi', 'tag:cloud')"
  when: tailscale_ssh_enabled | default(true) | bool
  tags: [tailscale_ssh]

- block:
    - name: Check if Tailscale is installed
      ansible.builtin.command: which tailscale
      register: tailscale_installed
      changed_when: false
      failed_when: false
      tags: [tailscale_ssh]

    - name: Fail if Tailscale is not installed
      ansible.builtin.fail:
        msg: >-
          Tailscale is not installed on this host. Install Tailscale first.
      when: tailscale_installed.rc != 0
      tags: [tailscale_ssh]

    - name: Get current Tailscale status
      ansible.builtin.command: tailscale status --json
      register: tailscale_status_raw
      changed_when: false
      failed_when: false
      tags: [tailscale_ssh]

    - name: Parse Tailscale status for auth check
      ansible.builtin.set_fact:
        tailscale_backend_state: >-
          {{ (tailscale_status_raw.stdout | from_json).BackendState
             | default('Unknown') }}
      when: tailscale_status_raw.rc == 0
      failed_when: false
      tags: [tailscale_ssh]

    - name: Check if Tailscale needs authentication
      ansible.builtin.set_fact:
        tailscale_needs_auth: >-
          {{ tailscale_status_raw.rc != 0 or
             tailscale_backend_state | default('Unknown')
               not in ['Running', 'Starting'] }}
      tags: [tailscale_ssh]

    - name: Display Tailscale backend state
      ansible.builtin.debug:
        msg: >-
          Backend state: {{ tailscale_backend_state | default('Unknown') }},
          Needs auth: {{ tailscale_needs_auth }}
      tags: [tailscale_ssh]

    - name: Handle unauthenticated state with auth key
      when: tailscale_needs_auth | bool
      block:
        - name: Validate auth key is provided for re-authentication
          ansible.builtin.assert:
            that:
              - tailscale_ssh_auth_key | length > 0
            fail_msg: >-
              Tailscale is logged out and requires re-authentication.
              Set tailscale_ssh_auth_key (from Ansible vault) to enable
              automatic re-auth. Generate a reusable, pre-authorized key at
              https://login.tailscale.com/admin/settings/keys
          tags: [tailscale_ssh]

        - name: Authenticate with Tailscale using auth key
          ansible.builtin.command: >-
            tailscale up
            --auth-key={{ tailscale_ssh_auth_key }}
            --ssh
            --advertise-tags={{ tailscale_ssh_tag }}
            {{ '--accept-routes' if tailscale_ssh_accept_routes | default(true)
               else '' }}
            {{ '--advertise-routes=' + tailscale_ssh_advertise_routes
               if tailscale_ssh_advertise_routes | length > 0 else '' }}
            --accept-risk=lose-ssh
            --reset
          register: tailscale_auth_result
          no_log: true  # Hide auth key from logs
          tags: [tailscale_ssh]

        - name: Wait for Tailscale to reach Running state
          ansible.builtin.command: tailscale status --json
          register: tailscale_post_auth_check
          until: >-
            tailscale_post_auth_check.rc == 0 and
            (tailscale_post_auth_check.stdout | from_json).BackendState
              | default('') == 'Running'
          retries: 12
          delay: 5
          changed_when: false
          tags: [tailscale_ssh]
      tags: [tailscale_ssh]

    # Re-check status after potential re-authentication
    - name: Get Tailscale status after auth check
      ansible.builtin.command: tailscale status --json
      register: tailscale_status_raw
      changed_when: false
      failed_when: false
      tags: [tailscale_ssh]

    - name: Parse Tailscale status
      ansible.builtin.set_fact:
        tailscale_status: "{{ tailscale_status_raw.stdout | from_json }}"
      when: tailscale_status_raw.rc == 0
      tags: [tailscale_ssh]

    - name: Check if Tailscale is logged in
      ansible.builtin.set_fact:
        tailscale_logged_in: >-
          {{ tailscale_status.BackendState | default('') == 'Running' }}
      when: tailscale_status is defined
      tags: [tailscale_ssh]

    - name: Get current Tailscale preferences
      ansible.builtin.command: tailscale debug prefs
      register: tailscale_prefs_raw
      changed_when: false
      when: tailscale_logged_in | default(false)
      tags: [tailscale_ssh]

    - name: Parse Tailscale preferences
      ansible.builtin.set_fact:
        tailscale_prefs: "{{ tailscale_prefs_raw.stdout | from_json }}"
      when:
        - tailscale_logged_in | default(false)
        - tailscale_prefs_raw.stdout | length > 0
      tags: [tailscale_ssh]

    - name: Extract current Tailscale settings
      ansible.builtin.set_fact:
        tailscale_ssh_already_enabled: >-
          {{ tailscale_prefs.RunSSH | default(false) }}
        tailscale_current_tags: >-
          {{ tailscale_prefs.AdvertiseTags | default([]) }}
        tailscale_current_routes: >-
          {{ tailscale_prefs.AdvertiseRoutes | default([]) | join(',') }}
        tailscale_current_accept_routes: >-
          {{ tailscale_prefs.RouteAll | default(false) }}
      when: tailscale_prefs is defined
      tags: [tailscale_ssh]

    - name: Determine if Tailscale configuration needs update
      ansible.builtin.set_fact:
        # Compare full tag set, not just presence of desired tag
        # This ensures stale tags are removed on re-runs
        tailscale_needs_update: >-
          {{
            not (tailscale_ssh_already_enabled | default(false)) or
            (tailscale_current_tags | default([]) | sort !=
             [tailscale_ssh_tag] | sort) or
            (tailscale_ssh_advertise_routes | default('') !=
             tailscale_current_routes | default('')) or
            ((tailscale_ssh_accept_routes | default(true) | bool) !=
             (tailscale_current_accept_routes | default(false) | bool))
          }}
      when: tailscale_logged_in | default(false)
      tags: [tailscale_ssh]

    - name: Display current Tailscale SSH status
      ansible.builtin.debug:
        msg:
          - "Logged in: {{ tailscale_logged_in | default(false) }}"
          - "SSH enabled: {{ tailscale_ssh_already_enabled | default(false) }}"
          - "Current tags: {{ tailscale_current_tags | default([]) }}"
          - "Desired tags: {{ [tailscale_ssh_tag] }}"
          - "Current routes: {{ tailscale_current_routes | default('') }}"
          - "Desired routes: {{ tailscale_ssh_advertise_routes | default('') }}"
          - "Accept routes: {{ tailscale_current_accept_routes
               | default(false) }}"
          - "Desired accept-routes: {{ tailscale_ssh_accept_routes
               | default(true) }}"
          - "Needs update: {{ tailscale_needs_update | default(false) }}"
      tags: [tailscale_ssh]

    - name: Build tailscale up command
      ansible.builtin.set_fact:
        tailscale_up_cmd: >-
          tailscale up --ssh
          --advertise-tags={{ tailscale_ssh_tag }}
          {{ '--accept-routes' if tailscale_ssh_accept_routes | default(true)
             else '' }}
          {{ '--advertise-routes=' + tailscale_ssh_advertise_routes
             if tailscale_ssh_advertise_routes | length > 0 else '' }}
          --accept-risk=lose-ssh
          --reset
      when: tailscale_needs_update | default(false)
      tags: [tailscale_ssh]

    - name: Configure Tailscale SSH
      ansible.builtin.command: "{{ tailscale_up_cmd }}"
      register: tailscale_up_result
      when: tailscale_needs_update | default(false)
      tags: [tailscale_ssh]

    - name: Wait for Tailscale to be ready
      ansible.builtin.command: tailscale status
      register: tailscale_ready_check
      until: tailscale_ready_check.rc == 0
      retries: "{{ (tailscale_ssh_ready_timeout | int / 5) | int }}"
      delay: 5
      changed_when: false
      when: tailscale_needs_update | default(false)
      tags: [tailscale_ssh]

    - name: Fail if Tailscale is still not logged in after auth attempt
      ansible.builtin.fail:
        msg: >-
          Tailscale is not logged in. Auth key may be invalid or expired.
          Check TAILSCALE_JOIN_KEY and ensure it's a valid, reusable,
          pre-authorized key with appropriate tags.
      when: not (tailscale_logged_in | default(false))
      tags: [tailscale_ssh]

    - name: Verify Tailscale SSH is enabled
      ansible.builtin.command: tailscale debug prefs
      register: tailscale_verify_raw
      changed_when: false
      when: tailscale_logged_in | default(false)
      tags: [tailscale_ssh]

    - name: Parse verification result
      ansible.builtin.set_fact:
        tailscale_verify: "{{ tailscale_verify_raw.stdout | from_json }}"
      when: tailscale_logged_in | default(false)
      tags: [tailscale_ssh]

    - name: Confirm Tailscale SSH configuration
      ansible.builtin.assert:
        that:
          - tailscale_verify.RunSSH | default(false)
        fail_msg: "Tailscale SSH failed to enable. Check Tailscale logs."
        success_msg: >-
          Tailscale SSH is enabled with tags:
          {{ tailscale_verify.AdvertiseTags | default([]) }}
      when: tailscale_logged_in | default(false)
      tags: [tailscale_ssh]

    # Deploy systemd service for automatic re-authentication on boot
    # This ensures Tailscale SSH works after reboots without manual intervention
    - name: Deploy auto-auth systemd service
      when: tailscale_ssh_auth_key | default('') | length > 0
      block:
        - name: Create Tailscale config directory
          ansible.builtin.file:
            path: /etc/tailscale
            state: directory
            owner: root
            group: root
            mode: "0700"
          tags: [tailscale_ssh]

        - name: Deploy Tailscale auth configuration
          ansible.builtin.template:
            src: tailscale-auth.conf.j2
            dest: /etc/tailscale/auth.conf
            owner: root
            group: root
            mode: "0600"
          no_log: true  # Hide auth key from logs
          tags: [tailscale_ssh]

        - name: Deploy Tailscale auto-auth systemd service
          ansible.builtin.template:
            src: tailscale-autoauth.service.j2
            dest: /etc/systemd/system/tailscale-autoauth.service
            owner: root
            group: root
            mode: "0644"
          register: tailscale_service_deployed
          tags: [tailscale_ssh]

        - name: Reload systemd daemon
          ansible.builtin.systemd:
            daemon_reload: true
          when: tailscale_service_deployed.changed
          tags: [tailscale_ssh]

        - name: Enable Tailscale auto-auth service
          ansible.builtin.systemd:
            name: tailscale-autoauth
            enabled: true
          tags: [tailscale_ssh]

        - name: Display auto-auth service status
          ansible.builtin.debug:
            msg: >-
              Tailscale auto-auth service deployed. Tailscale will
              automatically re-authenticate on boot using the auth key.
          tags: [tailscale_ssh]
      tags: [tailscale_ssh]

  when: tailscale_ssh_enabled | default(true) | bool
