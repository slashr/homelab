---
# Install and configure Tailscale on all nodes
- name: Install and Configure Tailscale
  hosts:
    - pis
    - oracle_workers
    - gcp_workers
  become: true
  gather_facts: false
  strategy: free  # Parallel execution - don't wait for slower hosts
  vars:
    tailscale_version: "latest"
    tailscale_args: ""
  tasks:
    - name: Check if Tailscale is already installed
      ansible.builtin.stat:
        path: /usr/sbin/tailscaled
      register: tailscale_binary

    - name: Download tailscale script
      ansible.builtin.get_url:
        url: https://tailscale.com/install.sh
        dest: /tmp/tailscale.sh
        mode: "0755"
        force: true
      when: not tailscale_binary.stat.exists
      register: download_result
      until: download_result is success
      retries: 3
      delay: 5

    - name: Install Tailscale
      ansible.builtin.command: /tmp/tailscale.sh
      when: not tailscale_binary.stat.exists
      register: install_result
      failed_when: install_result.rc != 0 and "already installed" not in install_result.stderr
      changed_when: install_result.rc == 0

    - name: Ensure tailscale service is enabled and running
      ansible.builtin.systemd:
        name: tailscaled
        state: started
        enabled: true

    - name: Update Tailscale to latest version
      ansible.builtin.command: tailscale update --yes
      register: tailscale_update
      changed_when: "'Updated' in tailscale_update.stdout"
      failed_when: false  # Don't fail if already up to date

    - name: Check if Tailscale needs authentication
      ansible.builtin.command: tailscale status
      register: tailscale_auth_check
      changed_when: false
      failed_when: false

    - name: Configure Tailscale with join key
      ansible.builtin.command: tailscale up --authkey={{ lookup('env', 'TAILSCALE_JOIN_KEY') }} --ssh --accept-risk=lose-ssh
      when:
        - lookup('env', 'TAILSCALE_JOIN_KEY') is defined
        - lookup('env', 'TAILSCALE_JOIN_KEY') | length > 0
        - tailscale_auth_check.rc != 0 or 'Logged out' in tailscale_auth_check.stdout
      register: tailscale_up
      changed_when: "'Success' in tailscale_up.stdout"
      failed_when: tailscale_up.rc != 0
      no_log: true

    - name: Check Tailscale SSH status
      ansible.builtin.command: tailscale status --json
      register: tailscale_status
      changed_when: false
      failed_when: tailscale_status.rc != 0

    - name: Enable Tailscale SSH if disabled
      ansible.builtin.command: tailscale set --ssh=true --accept-risk=lose-ssh
      when: >
        (tailscale_status.stdout | from_json).Self.SSHEnabled is not defined or
        (tailscale_status.stdout | from_json).Self.SSHEnabled | bool == false
      register: tailscale_set_ssh
      changed_when: "'aborted' not in tailscale_set_ssh.stderr and tailscale_set_ssh.rc == 0"

    - name: Enable Tailscale route acceptance when requested
      ansible.builtin.command: tailscale set --accept-routes=true
      when: tailscale_accept_routes | default(false) | bool
      register: tailscale_accept_routes_result
      changed_when: "'aborted' not in tailscale_accept_routes_result.stderr and tailscale_accept_routes_result.rc == 0"

    - name: Advertise Tailscale subnet routes when configured
      ansible.builtin.command: "tailscale set --advertise-routes={{ tailscale_advertise_routes }}"
      when: tailscale_advertise_routes | default('') | length > 0
      register: tailscale_advertise_routes_result
      changed_when: "'aborted' not in tailscale_advertise_routes_result.stderr and tailscale_advertise_routes_result.rc == 0"

    - name: Check Tailscale status
      ansible.builtin.command: tailscale status
      register: tailscale_status
      changed_when: false
      failed_when: tailscale_status.rc != 0
