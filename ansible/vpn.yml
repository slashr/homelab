- name: Remove Wireguard on all hosts
  hosts: vpn
  tasks:
    - name: Remove
      ansible.builtin.apt:
        name: wireguard
        state: absent
        update_cache: true
      become: true

- name: Enable IP forwarding
  hosts: amd1
  tasks:
    - name: Set ip_forward flag to 1
      ansible.posix.sysctl:
        name: net.ipv4.ip_forward
        value: '1'
        sysctl_set: true
        state: present
        reload: true
      become: true

- name: Configure iptables on Oracle
  hosts: amd1
  tasks:
    - name: Copy configuration to /etc/iptables/rules.v4
      ansible.builtin.copy:
        src: ./confs/iptables.conf
        decrypt: true
        dest: "/etc/iptables/rules.v4"
        mode: '640'
    - name: Load iptables rules
      ansible.builtin.command: iptables-restore /etc/iptables/rules.v4
      changed_when: false
    - name: Save iptables configuration persistently
      ansible.builtin.command: netfilter-persistent save
      changed_when: false
  become: true

- name: Install Tailscale
  hosts:
    - vpn
    - pi-workers
    - oracle-workers
    - gcp-workers
  tasks:
    - name: Install Tailscale
      ansible.builtin.apt:
        name: tailscale
        state: present
        update_cache: true
      become: true
  become: true
